---
layout:     post
references: ["http://martinfowler.com/bliki/BlueGreenDeployment.html|Blue/Green Deployment - Martin Fowler",
"https://aws.amazon.com/about-aws/whats-new/2014/07/10/introducing-amazon-cloudwatch-logs/|Amazon CloudWatch Logs",
"https://marketplace.sitecore.net/Modules/S/Sitecore_Log_Analyzer.aspx|Sitecore Log Analyzer"]
title:      "Sync Sitecore Logs to AWS CloudWatch Logs"
subtitle:   "Pushing Sitecore log files to AWS CloudWatch logs"
date:       2015-12-16 08:12:00
description: "Sync Sitecore log files to AWS CloudWatch logs"
tags: [aws, sitecore]
---

<p>Cloud hosted infrastructure introduces the challenge of monitoring
servers on instances which will be not be around forever. Whether
instances are terminated during a blue/green deployment or during a scale
down action of an auto scaling group, log files generated by Sitecore
will be lost.</p>

<p>One method of shipping these logs off the server is to use <em>AWS CloudWatch
Logs</em>. AWS Windows AMIs come pre-configured with the <em>EC2ConfigService</em>
which has the functionality to sync log files to <em>AWS CloudWatch Logs</em>. 
Follow this guide to enable this with Sitecore log files:</p>

<ol>
	<li><strong>Update <em>log4net</em> Configuration</strong> (Optional)<br />
	<em>This step is only required if you need to keep the log
	files on the server in a format which the Sitecore Log Analyzer can parse.</em><br /><br />
	<em>CloudWatch Logs</em> identifies a new log entry by a time stamp, to 
	satisfy this you must change the thread parameter (usually <em>%4t</em>) to 
	be a fixed number so that both <em>CloudWatch Logs</em> can identify a new 
	log entry and <em>Sitecore Log Analyzer</em> can parse successfully. 
	See line 6 where this has been changed to <em>9999</em>:

{% highlight xml linenos %}
<log4net>
  <appender name="LogFileAppender" type="log4net.Appender.SitecoreLogFileAppender, Sitecore.Logging">
    <file value="$(dataFolder)/logs/log.{date}.txt" />
    <appendToFile value="true" />
      <layout type="log4net.Layout.PatternLayout">
        <conversionPattern value="9999 %d{ABSOLUTE} %-5p %m%n" />
      </layout>
    <encoding value="utf-8" />
  </appender>
</log4net>
{% endhighlight %}
	<br /></li>
	<li><strong>Update JSON CloudWatch Logs configuration</strong><br />
	The <em>CloudWatch Logs</em> configuration file is located on the server 
	in directory <em style="word-break:break-all">C:\Program Files\Amazon\Ec2ConfigService\Settings\AWS.EC2.Windows.CloudWatch.json</em>.
	The AWS guide to <em><strong><a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/UsingConfig_WinAMI.html#send_logs_to_cwl">
	Configuring a Windows Instance Using the EC2Config Service</a></strong></em> 
	has a good introduction on how to set up pushing different types of logs to 
	<em>CloudWatch Logs</em>, however the following	example should be a good guide 
	to getting started with Sitecore log files:
{% highlight json linenos %}
{ 
 "schemaVersion":"1.0",
 "description":"Sitecore Logs CloudWatch",
 "runtimeConfig":{ 
    "aws:cloudWatch":{ 
      "properties":{ 
        "EngineConfiguration":{ 
          "PollInterval":"00:00:15",
          "Components":[ 
            {
              "Id": "SitecoreLogs",
              "FullName": "AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch",
              "Parameters": {
                "LogDirectoryPath": "C:\\inetpub\\www.contoso.com\\Data\\logs",
                "TimestampFormat": "9999 HH:mm:ss",
                "Encoding": "UTF-8",
                "Filter": "log*.txt",
                "CultureName": "en-GB",
                "TimeZoneKind": "Local",
                "LineCount": ""
              }
            },
            { 
              "Id":"CloudWatchLogs",
              "FullName":"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch",
              "Parameters":{ 
                "AccessKey": "",
                "SecretKey": "",
                "Region": "eu-west-1",
                "LogGroup": "sitecore-logs",
                "LogStream": "{instance_id}"
              }
            }
          ],
          "Flows":{ 
            "Flows":[ 
              "SitecoreLogs, CloudWatchLogs"
            ]
          }
        }
      }
    }
  }
}
{% endhighlight %}
	<br />
	<span class="small">Notes:</span>
	<ul class="small">
		<li>Line 15: Matches 9999 which was defined in step 1 (if you 
		skipped this step replace with <em>HH:mm:ss</em>)</li>
		<li>Line 27/28: The AccessKey/SecretKey has been left empty as this will 
		come from the EC2 instance's IAM role (see step 3)</li>
		<li>Line 31: The log stream will be automatically called the same name as
		the EC2 instance ID</li>
	</ul>	
	</li><br />
	<li><strong>IAM settings</strong><br />
	The configuration above has no values set for the <em>AccessKey</em> and 
	<em>SecretKey</em>. This is because the EC2 instance's <em>IAM Role</em> 
	has been set up to allow writing to <em>CloudWatch Logs</em>. If this hasn't been done, 
	then an <em>AccessKey</em> and <em>SecretKey</em> with these permissions 
	is required. The following is an example of the <em>IAM policy</em> that is required:
{% highlight json %}
{
  "Statement": [
    {
      "Resource": "*",
      "Action": [
        "logs:PutLogEvents",
        "logs:Create*",
        "logs:Describe*"
      ],
      "Effect": "Allow"
    }
  ]
}
{% endhighlight %}
	<br /></li>	
	<li><strong>Enable CloudWatch logs</strong><br />
	The final step is to enable <em>CloudWatch Logs</em>. To do this, open the <em>EC2ConfigService</em> 
	Settings and ensure the <q>Enable CloudWatch Logs integration</q> checkbox is checked:
	<img src="/assets/2015-12-16-sync-sitecore-logs-to-cloudwatch-logs/EnableCloudWatchLogs.jpg" alt="Enable CloudWatch Logs integration"/>
	<br /></li>
	<li><strong>Check results</strong><br />
	<span>The easiest way to check that everything is working is to log into the AWS 
	Console and navigate to <em>CloudWatch Logs</em>. Here you should see a new
	<em>Log Group</em> has been created called <q>sitecore-logs</q> and within it you'll see
	<em>Log Streams</em> containing log entries:</span><br /><br />
	<img src="/assets/2015-12-16-sync-sitecore-logs-to-cloudwatch-logs/LogGroup.jpg" alt="CloudWatch Logs Log Group"/><br />
	<img src="/assets/2015-12-16-sync-sitecore-logs-to-cloudwatch-logs/LogStream.jpg" alt="CloudWatch Logs Log Stream"/><br />
	<img src="/assets/2015-12-16-sync-sitecore-logs-to-cloudwatch-logs/LogEntries.jpg" alt="CloudWatch Logs Log Entries"/><br />
	<span>If it doesn't look like it's working, then check the EC2Config Service log file 
	(<em style="word-break:break-all">C:\Program Files\Amazon\Ec2ConfigService\Logs\Ec2ConfigLog.txt</em>)
	to see if there are any errors with your setup.</span>
	</li>
</ol>