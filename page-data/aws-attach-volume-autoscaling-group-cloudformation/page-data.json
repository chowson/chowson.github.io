{"componentChunkName":"component---src-templates-post-tsx","path":"/aws-attach-volume-autoscaling-group-cloudformation/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Attach Volume to EC2 instance in Auto Scaling Group","path":"/aws-attach-volume-autoscaling-group-cloudformation","date":"November 28, 2015","dateIso":"2015-11-28T22:12:00.000Z","tags":["aws"],"references":["http://docs.aws.amazon.com/AutoScaling/latest/DeveloperGuide/GettingStartedTutorial.html|Auto Scaling Documentation","http://docs.aws.amazon.com/AutoScaling/latest/DeveloperGuide/WorkingWithLaunchConfig.html|Creating Launch Configuration","http://docs.aws.amazon.com/AutoScaling/latest/DeveloperGuide/schedule_time.html|Scheduled Scaling"],"description":"Attaching a volume to an EC2 instance in an Auto Scaling Group using Powershell and CloudFormation"},"html":"<p>During the process of creating an <em>AWS Auto Scaling group</em>, you will need to\ncreate a <em>Launch Configuration</em> to describe how EC2 instances will be created.\nWhen configuring the storage options, new volumes can be added and can be optionally\nbe based off a snapshot. However, there is no option to attach an existing volume.</p>\n<p>The reason behind this is a volume can only be attached to a single EC2 instance and\nan <em>Auto Scaling Group</em> is likely to have multiple instances created from the same\n<em>Launch Configuration</em>. However, in the scenario where a group is being scaled between 0\nand 1 instance, there is no reason why you can't add a volume to the instance when you\nscale up to 1 instance. I had this scenario with a dev server which was scaled to 0 instances\nat night and back to 1 instance during working hours.</p>\n<p>To get a volume to attach to an EC2 instance when it is created, add the following Powershell\nto the <em>UserData</em> property of the <em>Launch Configuration</em>. This ensures each time an instance\nis created, the volume will be available in the same state as the previous day.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>powershell</span><span class=\"token punctuation\">></span></span>\n$instanceId = Invoke-RestMethod -Uri http://169.254.169.254/latest/meta-data/instance-id \nAdd-EC2Volume -instanceId $instanceId -VolumeId vol-xxxxxxxx -Device xvdb -Region eu-west-1\nGet-Disk | %{ Set-Disk -Number $_.Number -IsOffline $False }\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>powershell</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>If you are using <em>CloudFormation</em>, this would be added to the template as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"AWSTemplateFormatVersion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2010-09-09\"</span><span class=\"token punctuation\">,</span>\n  ...\n  <span class=\"token property\">\"Resources\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    ...\n    <span class=\"token property\">\"LaunchConfig\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::AutoScaling::LaunchConfiguration\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        ...\n    \t<span class=\"token property\">\"UserData\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"Fn::Base64\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Fn::Join\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n              <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">\"&lt;powershell>\\n\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"$instanceId = Invoke-RestMethod -Uri http://169.254.169.254/latest/meta-data/instance-id \\n\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"Add-EC2Volume -instanceId $instanceId -VolumeId vol-xxxxxxxx -Device xvdb -Region eu-west-1\\n\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"Get-Disk | %{ Set-Disk -Number $_.Number -IsOffline $False }\\n\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"&lt;/powershell>\\n\"</span>\n              <span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">]</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    ...\n  <span class=\"token punctuation\">}</span>\n  ...</code></pre></div>","timeToRead":1}},"pageContext":{"id":"e8a324a5-a6d3-5cd3-bd72-c5344ce601e5"}},"staticQueryHashes":["1942088059"],"slicesMap":{}}