{"componentChunkName":"component---src-templates-post-tsx","path":"/find-sitecore-users-with-profile-setting/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Find Sitecore users with profile setting","path":"/find-sitecore-users-with-profile-setting","date":"July 28, 2015","dateIso":"2015-07-28T19:14:00.000Z","tags":["sitecore","sql","debugging"],"references":null,"description":"Find Sitecore users with profile setting"},"html":"<p>Through the role manager, you can easily find which users are in a particular role but you can't easily\nget a list of users which are an administrator. This is because the administrator setting is stored as a\nprofile value on the user. To generate a list of administrators run the following script against your\n<em>core</em> database.</p>\n<p>You can also modify the script to find users with the existence of any profile key and optionally users which have a profile key that matches a particular  value. To do this you will need to modify the <em>@propertyKey</em> and <em>@expectedValue</em> variables at the top of the script. Leaving <em>@expectedValue</em> as an empty string will return users which have the existence of a profile key rather than trying to match it to a value.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">DECLARE</span> <span class=\"token variable\">@propertyKey</span> <span class=\"token keyword\">AS</span> nvarchar<span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@expectedValue</span> <span class=\"token keyword\">AS</span> nvarchar<span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">--SET PROPERTY KEY AND EXPECTED VALUE HERE</span>\n<span class=\"token keyword\">SET</span> <span class=\"token variable\">@propertyKey</span> <span class=\"token operator\">=</span> <span class=\"token string\">'IsAdministrator'</span>\n<span class=\"token keyword\">SET</span> <span class=\"token variable\">@expectedValue</span> <span class=\"token operator\">=</span> <span class=\"token string\">'True'</span>\n\n\n<span class=\"token keyword\">DECLARE</span> <span class=\"token variable\">@userId</span> <span class=\"token keyword\">AS</span> uniqueidentifier\n<span class=\"token keyword\">DECLARE</span> <span class=\"token variable\">@username</span> <span class=\"token keyword\">AS</span> nvarchar<span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">DECLARE</span> userCursor <span class=\"token keyword\">CURSOR</span> \n  <span class=\"token keyword\">LOCAL</span> STATIC READ_ONLY FORWARD_ONLY\n<span class=\"token keyword\">FOR</span> \n<span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">DISTINCT</span> UserId <span class=\"token keyword\">FROM</span> aspnet_Profile <span class=\"token keyword\">WHERE</span> PropertyNames <span class=\"token operator\">LIKE</span> <span class=\"token string\">'%'</span> <span class=\"token operator\">+</span> <span class=\"token variable\">@propertyKey</span> <span class=\"token operator\">+</span> <span class=\"token string\">'%'</span>\n\n<span class=\"token keyword\">OPEN</span> userCursor\n<span class=\"token keyword\">FETCH</span> <span class=\"token keyword\">NEXT</span> <span class=\"token keyword\">FROM</span> userCursor <span class=\"token keyword\">INTO</span> <span class=\"token variable\">@userId</span>\n<span class=\"token keyword\">WHILE</span> @<span class=\"token variable\">@FETCH_STATUS</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n<span class=\"token keyword\">BEGIN</span>\n    <span class=\"token comment\">-- Get property value start/end indexes from PropertyNames</span>\n    <span class=\"token keyword\">DECLARE</span> <span class=\"token variable\">@propertyNames</span> <span class=\"token keyword\">AS</span> NVARCHAR<span class=\"token punctuation\">(</span>max<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">SET</span> <span class=\"token variable\">@propertyNames</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> PropertyNames <span class=\"token keyword\">FROM</span> aspnet_Profile <span class=\"token keyword\">WHERE</span> UserId <span class=\"token operator\">=</span> <span class=\"token variable\">@userId</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">SET</span> <span class=\"token variable\">@username</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> UserName <span class=\"token keyword\">FROM</span> aspnet_Users <span class=\"token keyword\">WHERE</span> UserId <span class=\"token operator\">=</span> <span class=\"token variable\">@userId</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">DECLARE</span> <span class=\"token variable\">@startIndex</span> <span class=\"token keyword\">AS</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@endIndex</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">int</span>\n    <span class=\"token keyword\">SET</span> <span class=\"token variable\">@startIndex</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>CHARINDEX<span class=\"token punctuation\">(</span><span class=\"token variable\">@propertyKey</span> <span class=\"token operator\">+</span> <span class=\"token string\">':S:'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@propertyNames</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">LEN</span><span class=\"token punctuation\">(</span><span class=\"token variable\">@propertyKey</span> <span class=\"token operator\">+</span> <span class=\"token string\">':S:'</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">DECLARE</span> <span class=\"token variable\">@pos</span> <span class=\"token keyword\">AS</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@count</span> <span class=\"token keyword\">AS</span> <span class=\"token keyword\">int</span>\n    <span class=\"token keyword\">SET</span> <span class=\"token variable\">@count</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">SET</span> <span class=\"token variable\">@pos</span> <span class=\"token operator\">=</span> <span class=\"token variable\">@startIndex</span>\n    \n    <span class=\"token keyword\">WHILE</span><span class=\"token punctuation\">(</span><span class=\"token variable\">@count</span> <span class=\"token operator\">!=</span> <span class=\"token number\">2</span> <span class=\"token operator\">AND</span> SUBSTRING<span class=\"token punctuation\">(</span><span class=\"token variable\">@propertyNames</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@pos</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">BEGIN</span>\n\t\t<span class=\"token keyword\">IF</span> SUBSTRING<span class=\"token punctuation\">(</span><span class=\"token variable\">@propertyNames</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@pos</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token string\">':'</span>\n\t\t\t<span class=\"token keyword\">SET</span> <span class=\"token variable\">@count</span> <span class=\"token operator\">=</span> <span class=\"token variable\">@count</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n\t\t<span class=\"token keyword\">SET</span> <span class=\"token variable\">@pos</span> <span class=\"token operator\">=</span> <span class=\"token variable\">@pos</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n\t\t<span class=\"token keyword\">END</span>\n    \n    <span class=\"token keyword\">SET</span> <span class=\"token variable\">@propertyNames</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>SUBSTRING<span class=\"token punctuation\">(</span><span class=\"token variable\">@propertyNames</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@startIndex</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">@pos</span> <span class=\"token operator\">-</span> <span class=\"token variable\">@startIndex</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">SET</span> <span class=\"token variable\">@startIndex</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>SUBSTRING<span class=\"token punctuation\">(</span><span class=\"token variable\">@propertyNames</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>CHARINDEX<span class=\"token punctuation\">(</span><span class=\"token string\">':'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@propertyNames</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">SET</span> <span class=\"token variable\">@endIndex</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>SUBSTRING<span class=\"token punctuation\">(</span><span class=\"token variable\">@propertyNames</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>CHARINDEX<span class=\"token punctuation\">(</span><span class=\"token string\">':'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@propertyNames</span><span class=\"token punctuation\">)</span>  <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token function\">LEN</span><span class=\"token punctuation\">(</span><span class=\"token variable\">@propertyNames</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> CHARINDEX<span class=\"token punctuation\">(</span><span class=\"token string\">':'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@propertyNames</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\">-- Verify PropertyValue for IsAdministrator profile key is 'True'</span>\n    <span class=\"token keyword\">DECLARE</span> <span class=\"token variable\">@propertyStrings</span> <span class=\"token keyword\">AS</span> nvarchar<span class=\"token punctuation\">(</span>MAX<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">SET</span> <span class=\"token variable\">@propertyStrings</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> PropertyValuesString <span class=\"token keyword\">FROM</span> aspnet_Profile <span class=\"token keyword\">WHERE</span> UserId <span class=\"token operator\">=</span> <span class=\"token variable\">@userId</span><span class=\"token punctuation\">)</span>\n\t\n\t<span class=\"token keyword\">IF</span> <span class=\"token variable\">@expectedValue</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n\t\t<span class=\"token keyword\">BEGIN</span>\n\t\t\t<span class=\"token keyword\">print</span> <span class=\"token variable\">@username</span> <span class=\"token operator\">+</span> <span class=\"token string\">', '</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>SUBSTRING<span class=\"token punctuation\">(</span><span class=\"token variable\">@propertyStrings</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@startIndex</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@endIndex</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">END</span>\n\t<span class=\"token keyword\">ELSE</span>\n\t\t<span class=\"token keyword\">BEGIN</span>\n\t\t\t<span class=\"token keyword\">IF</span> SUBSTRING<span class=\"token punctuation\">(</span><span class=\"token variable\">@propertyStrings</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@startIndex</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@endIndex</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token variable\">@expectedValue</span>\n\t\t\t\t<span class=\"token keyword\">BEGIN</span>\n\t\t\t\t<span class=\"token keyword\">print</span> <span class=\"token variable\">@username</span>   \n\t\t\t<span class=\"token keyword\">END</span>\n\t\t<span class=\"token keyword\">END</span>\n\t\t\n    <span class=\"token keyword\">FETCH</span> <span class=\"token keyword\">NEXT</span> <span class=\"token keyword\">FROM</span> userCursor <span class=\"token keyword\">INTO</span> <span class=\"token variable\">@userId</span>\n<span class=\"token keyword\">END</span>\n<span class=\"token keyword\">CLOSE</span> userCursor\n<span class=\"token keyword\">DEALLOCATE</span> userCursor</code></pre></div>","timeToRead":2}},"pageContext":{"id":"bb8465d1-e4db-5942-bcc2-791d9575ec20"}},"staticQueryHashes":["1942088059"],"slicesMap":{}}