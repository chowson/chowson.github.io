{"componentChunkName":"component---src-templates-post-tsx","path":"/empty-sitecore-recycle-bin-periodically/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Empty Sitecore Recycle Bin Periodically","path":"/empty-sitecore-recycle-bin-periodically","date":"July 26, 2016","dateIso":"2016-07-26T09:45:34.000Z","tags":["sitecore"],"references":[],"description":"Empty Sitecore Recycle Bin Periodically"},"html":"<p>The recycle bin and archive within Sitecore are useful features\nfor content editors, the problem is that unless somebody proactively\nkeeps removing items from them, then they will keep growing in size.\nFor example, I once saw the archive tables reach 3GB.</p>\n<p>Firstly, the following Sitecore setting must be set to <em>true</em>\nto ensure items are put in the recycle bin rather than being\npermanently deleted when a content editor deletes an item:</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>setting</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>RecycleBinActive<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>To remove the need for somebody to keep going into the Sitecore\nclient and cleaning up the recycle bin (or archive) manually, the following\nSitecore Job will keep checking the entries on a set interval and\nremove any items older than the configured <em>DaysToKeep</em> setting.\nFor example, you could configure the job to keep all items deleted in the past\n90 days but remove older items as they are unlikely to be needed:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CleanupArchiveEntries</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> PageSize <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> DaysToKeep <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> ArchiveName <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> DatabaseName <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Assert<span class=\"token punctuation\">.</span><span class=\"token function\">IsNotNullOrEmpty</span><span class=\"token punctuation\">(</span>ArchiveName<span class=\"token punctuation\">,</span> <span class=\"token string\">\"ArchiveName was not provided, please use recyclebin or archive\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Assert<span class=\"token punctuation\">.</span><span class=\"token function\">IsNotNullOrEmpty</span><span class=\"token punctuation\">(</span>DatabaseName<span class=\"token punctuation\">,</span> <span class=\"token string\">\"DatabaseName was not provided\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Assert<span class=\"token punctuation\">.</span><span class=\"token function\">IsNotNull</span><span class=\"token punctuation\">(</span>DaysToKeep<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Days to keep was not provided\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> archive <span class=\"token operator\">=</span> ArchiveManager<span class=\"token punctuation\">.</span><span class=\"token function\">GetArchive</span><span class=\"token punctuation\">(</span>ArchiveName<span class=\"token punctuation\">,</span> Database<span class=\"token punctuation\">.</span><span class=\"token function\">GetDatabase</span><span class=\"token punctuation\">(</span>DatabaseName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">LogEntryCount</span><span class=\"token punctuation\">(</span>archive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> entriesToRemove <span class=\"token operator\">=</span> <span class=\"token function\">FindOldArchiveEntries</span><span class=\"token punctuation\">(</span>archive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">RemoveOldArchiveEntries</span><span class=\"token punctuation\">(</span>archive<span class=\"token punctuation\">,</span> entriesToRemove<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">LogEntryCount</span><span class=\"token punctuation\">(</span>archive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\">ArchiveEntry<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> <span class=\"token function\">GetArchivePageEntries</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Archive</span> archive<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> page<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> archive<span class=\"token punctuation\">.</span><span class=\"token function\">GetEntries</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">,</span> PageSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\">ArchiveEntry<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> <span class=\"token function\">GetArchiveEntryItemsToRemove</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArchiveEntry<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> archiveEntries<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> archiveEntries<span class=\"token punctuation\">.</span><span class=\"token function\">Where</span><span class=\"token punctuation\">(</span>item <span class=\"token operator\">=></span> item<span class=\"token punctuation\">.</span>ArchiveDate <span class=\"token operator\">&lt;</span> DateTime<span class=\"token punctuation\">.</span>Now<span class=\"token punctuation\">.</span><span class=\"token function\">AddDays</span><span class=\"token punctuation\">(</span>DaysToKeep <span class=\"token operator\">*</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">LogEntryCount</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Archive</span> archive<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> archiveCount <span class=\"token operator\">=</span> archive<span class=\"token punctuation\">.</span><span class=\"token function\">GetEntryCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Log<span class=\"token punctuation\">.</span><span class=\"token function\">Info</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span><span class=\"token function\">Format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Archive ({0}) contains {1} entries\"</span><span class=\"token punctuation\">,</span> archive<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">,</span> archiveCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">RemoveOldArchiveEntries</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Archive</span> archive<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ArchiveEntry<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> entriesToRemove<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Log<span class=\"token punctuation\">.</span><span class=\"token function\">Info</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span><span class=\"token function\">Format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Removing {0} entries\"</span><span class=\"token punctuation\">,</span> entriesToRemove<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> itemToRemove <span class=\"token keyword\">in</span> entriesToRemove<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            Context<span class=\"token punctuation\">.</span>Job<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">.</span>Processed<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n            archive<span class=\"token punctuation\">.</span><span class=\"token function\">RemoveEntries</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ID</span><span class=\"token punctuation\">(</span>itemToRemove<span class=\"token punctuation\">.</span>ArchivalId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\">IEnumerable<span class=\"token punctuation\">&lt;</span>ArchiveEntry<span class=\"token punctuation\">></span></span> <span class=\"token function\">FindOldArchiveEntries</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Archive</span> archive<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> page <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> itemsToRemove <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span>ArchiveEntry<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> archiveItems <span class=\"token operator\">=</span> <span class=\"token function\">GetArchivePageEntries</span><span class=\"token punctuation\">(</span>archive<span class=\"token punctuation\">,</span> page<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>archiveItems<span class=\"token punctuation\">.</span><span class=\"token function\">Any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> pageItemsToRemove <span class=\"token operator\">=</span> <span class=\"token function\">GetArchiveEntryItemsToRemove</span><span class=\"token punctuation\">(</span>archiveItems<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pageItemsToRemove<span class=\"token punctuation\">.</span><span class=\"token function\">Any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                itemsToRemove<span class=\"token punctuation\">.</span><span class=\"token function\">AddRange</span><span class=\"token punctuation\">(</span>pageItemsToRemove<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            page<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n            archiveItems <span class=\"token operator\">=</span> <span class=\"token function\">GetArchivePageEntries</span><span class=\"token punctuation\">(</span>archive<span class=\"token punctuation\">,</span> page<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> itemsToRemove<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To add the job to your application, create a new include file with\nthe following configuration:</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>configuration</span> <span class=\"token attr-name\"><span class=\"token namespace\">xmlns:</span>patch</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://www.sitecore.net/xmlconfig/<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>sitecore</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>scheduling</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>agent</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Your.Namespace.CleanupArchiveEntries, Mamba.Presentation.Website<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">method</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Run<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">interval</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>12:00:00<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>DaysToKeep</span><span class=\"token punctuation\">></span></span>365<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>DaysToKeep</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ArchiveName</span><span class=\"token punctuation\">></span></span>recyclebin<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ArchiveName</span><span class=\"token punctuation\">></span></span><span class=\"token comment\">&lt;!-- recyclebin or archive --></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>DatabaseName</span><span class=\"token punctuation\">></span></span>master<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>DatabaseName</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>agent</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>scheduling</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>sitecore</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>configuration</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>You can configure the <em>DaysToKeep</em>, <em>ArchiveName</em> and <em>DatabaseName</em>\nparameters to customise the job to run how you need it to be run. To run\nagainst multiple databases or multiple archives, simply specify multiple\n<em>agent</em> configuration nodes for each setup required.</p>\n<p>When the job runs, it will log something similar to the following\nif <em>INFO</em> logging is enabled:</p>\n<div class=\"gatsby-highlight\" data-language=\"tex\"><pre class=\"language-tex\"><code class=\"language-tex\">12:27:32 ManagedPoolThread #2 INFO  Job started: Your.Namespace.CleanupArchiveEntries\n12:27:32 ManagedPoolThread #2 INFO  Archive (recyclebin) contains 218 entries\n12:27:32 ManagedPoolThread #2 INFO  Removing 61 entries\n12:27:36 ManagedPoolThread #2 INFO  Archive (recyclebin) contains 157 entries\n12:27:36 ManagedPoolThread #2 INFO  Job ended: Your.Namespace.CleanupArchiveEntries (units processed: 61)</code></pre></div>","timeToRead":3}},"pageContext":{"id":"5f14b58f-3aeb-55a8-bfed-25d585646b97"}},"staticQueryHashes":["1942088059"],"slicesMap":{}}