{"hash":"23c5a0808afcefbf6c87f6b9ce8de4ac23bfba70","data":{"post":{"title":"Find Sitecore users with profile setting","description":"Find Sitecore users with profile setting","date":"July 28, 2015","timeToRead":2,"content":"<p>Through the role manager, you can easily find which users are in a particular role but you can't easily\nget a list of users which are an administrator. This is because the administrator setting is stored as a\nprofile value on the user. To generate a list of administrators run the following script against your\n<em>core</em> database.</p>\n<p>You can also modify the script to find users with the existence of any profile key and optionally users which have a profile key that matches a particular  value. To do this you will need to modify the <em>@propertyKey</em> and <em>@expectedValue</em> variables at the top of the script. Leaving <em>@expectedValue</em> as an empty string will return users which have the existence of a profile key rather than trying to match it to a value.</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440ff\"><code><span class=\"line\"><span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> @propertyKey </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">nvarchar</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #B48EAD\">50</span><span style=\"color: #D8DEE9FF\">), @expectedValue </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">nvarchar</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #B48EAD\">255</span><span style=\"color: #D8DEE9FF\">)</span></span>\n\n<span class=\"line\"><span style=\"color: #616E88\">--SET PROPERTY KEY AND EXPECTED VALUE HERE</span></span>\n<span class=\"line\"><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @propertyKey </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&#39;</span><span style=\"color: #A3BE8C\">IsAdministrator&#39;</span></span>\n<span class=\"line\"><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @expectedValue </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&#39;</span><span style=\"color: #A3BE8C\">True&#39;</span></span>\n\n\n<span class=\"line\"><span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> @userId </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">uniqueidentifier</span></span>\n<span class=\"line\"><span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> @username </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">nvarchar</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #B48EAD\">255</span><span style=\"color: #D8DEE9FF\">)</span></span>\n\n<span class=\"line\"><span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> userCursor </span><span style=\"color: #81A1C1\">CURSOR</span><span style=\"color: #D8DEE9FF\"> </span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">  </span><span style=\"color: #81A1C1\">LOCAL</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">STATIC</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">READ_ONLY</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">FORWARD_ONLY</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">FOR </span></span>\n<span class=\"line\"><span style=\"color: #81A1C1\">SELECT DISTINCT</span><span style=\"color: #D8DEE9FF\"> UserId </span><span style=\"color: #81A1C1\">FROM</span><span style=\"color: #D8DEE9FF\"> aspnet_Profile </span><span style=\"color: #81A1C1\">WHERE</span><span style=\"color: #D8DEE9FF\"> PropertyNames </span><span style=\"color: #81A1C1\">LIKE</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&#39;</span><span style=\"color: #A3BE8C\">%&#39;</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> @propertyKey </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&#39;</span><span style=\"color: #A3BE8C\">%&#39;</span></span>\n\n<span class=\"line\"><span style=\"color: #81A1C1\">OPEN</span><span style=\"color: #D8DEE9FF\"> userCursor</span></span>\n<span class=\"line\"><span style=\"color: #81A1C1\">FETCH</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">NEXT</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">FROM</span><span style=\"color: #D8DEE9FF\"> userCursor </span><span style=\"color: #81A1C1\">INTO</span><span style=\"color: #D8DEE9FF\"> @userId</span></span>\n<span class=\"line\"><span style=\"color: #81A1C1\">WHILE</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #88C0D0\">@@FETCH_STATUS</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">0</span></span>\n<span class=\"line\"><span style=\"color: #81A1C1\">BEGIN</span></span>\n<span class=\"line\"><span style=\"color: #ECEFF4\">    </span><span style=\"color: #616E88\">-- Get property value start/end indexes from PropertyNames</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> @propertyNames </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">NVARCHAR</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #88C0D0\">max</span><span style=\"color: #D8DEE9FF\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @propertyNames </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #81A1C1\">SELECT</span><span style=\"color: #D8DEE9FF\"> PropertyNames </span><span style=\"color: #81A1C1\">FROM</span><span style=\"color: #D8DEE9FF\"> aspnet_Profile </span><span style=\"color: #81A1C1\">WHERE</span><span style=\"color: #D8DEE9FF\"> UserId </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> @userId)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @username </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #81A1C1\">SELECT</span><span style=\"color: #D8DEE9FF\"> UserName </span><span style=\"color: #81A1C1\">FROM</span><span style=\"color: #D8DEE9FF\"> aspnet_Users </span><span style=\"color: #81A1C1\">WHERE</span><span style=\"color: #D8DEE9FF\"> UserId </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> @userId)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> @startIndex </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">int</span><span style=\"color: #D8DEE9FF\">, @endIndex </span><span style=\"color: #81A1C1\">as</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">int</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @startIndex </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #88C0D0\">CHARINDEX</span><span style=\"color: #D8DEE9FF\">(@propertyKey </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&#39;</span><span style=\"color: #A3BE8C\">:S:&#39;</span><span style=\"color: #D8DEE9FF\">, @propertyNames)) </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #88C0D0\">LEN</span><span style=\"color: #D8DEE9FF\">(@propertyKey </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&#39;</span><span style=\"color: #A3BE8C\">:S:&#39;</span><span style=\"color: #D8DEE9FF\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> @pos </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">int</span><span style=\"color: #D8DEE9FF\">, @count </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">int</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @count </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">0</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @pos </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> @startIndex</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">WHILE</span><span style=\"color: #D8DEE9FF\">(@count </span><span style=\"color: #81A1C1\">!=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">2</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">AND</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #88C0D0\">SUBSTRING</span><span style=\"color: #D8DEE9FF\">(@propertyNames, @pos, </span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">) </span><span style=\"color: #81A1C1\">!=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&#39;</span><span style=\"color: #A3BE8C\">&#39;</span><span style=\"color: #D8DEE9FF\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">BEGIN</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">IF</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #88C0D0\">SUBSTRING</span><span style=\"color: #D8DEE9FF\">(@propertyNames, @pos, </span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">) </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&#39;</span><span style=\"color: #A3BE8C\">:&#39;</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t</span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @count </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> @count </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">1</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @pos </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> @pos </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">1</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">END</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @propertyNames </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #88C0D0\">SUBSTRING</span><span style=\"color: #D8DEE9FF\">(@propertyNames, @startIndex, (@pos </span><span style=\"color: #81A1C1\">-</span><span style=\"color: #D8DEE9FF\"> @startIndex </span><span style=\"color: #81A1C1\">-</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">)))</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @startIndex </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #88C0D0\">SUBSTRING</span><span style=\"color: #D8DEE9FF\">(@propertyNames, </span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">, (</span><span style=\"color: #88C0D0\">CHARINDEX</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #ECEFF4\">&#39;</span><span style=\"color: #A3BE8C\">:&#39;</span><span style=\"color: #D8DEE9FF\">, @propertyNames) </span><span style=\"color: #81A1C1\">-</span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">)))</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @endIndex </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #88C0D0\">SUBSTRING</span><span style=\"color: #D8DEE9FF\">(@propertyNames, (</span><span style=\"color: #88C0D0\">CHARINDEX</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #ECEFF4\">&#39;</span><span style=\"color: #A3BE8C\">:&#39;</span><span style=\"color: #D8DEE9FF\">, @propertyNames)  </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">), (</span><span style=\"color: #88C0D0\">LEN</span><span style=\"color: #D8DEE9FF\">(@propertyNames) </span><span style=\"color: #81A1C1\">-</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #88C0D0\">CHARINDEX</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #ECEFF4\">&#39;</span><span style=\"color: #A3BE8C\">:&#39;</span><span style=\"color: #D8DEE9FF\">, @propertyNames))))</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span></span>\n<span class=\"line\"><span style=\"color: #ECEFF4\">    </span><span style=\"color: #616E88\">-- Verify PropertyValue for IsAdministrator profile key is &#39;True&#39;</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> @propertyStrings </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">nvarchar</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #88C0D0\">MAX</span><span style=\"color: #D8DEE9FF\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @propertyStrings </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #81A1C1\">SELECT</span><span style=\"color: #D8DEE9FF\"> PropertyValuesString </span><span style=\"color: #81A1C1\">FROM</span><span style=\"color: #D8DEE9FF\"> aspnet_Profile </span><span style=\"color: #81A1C1\">WHERE</span><span style=\"color: #D8DEE9FF\"> UserId </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> @userId)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t</span><span style=\"color: #81A1C1\">IF</span><span style=\"color: #D8DEE9FF\"> @expectedValue </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&#39;</span><span style=\"color: #A3BE8C\">&#39;</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">BEGIN</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t</span><span style=\"color: #81A1C1\">print</span><span style=\"color: #D8DEE9FF\"> @username </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&#39;</span><span style=\"color: #A3BE8C\">, &#39;</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #88C0D0\">SUBSTRING</span><span style=\"color: #D8DEE9FF\">(@propertyStrings, @startIndex </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">, @endIndex))</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">END</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t</span><span style=\"color: #81A1C1\">ELSE</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">BEGIN</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t</span><span style=\"color: #81A1C1\">IF</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #88C0D0\">SUBSTRING</span><span style=\"color: #D8DEE9FF\">(@propertyStrings, @startIndex, @endIndex </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">) </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> @expectedValue</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t\t</span><span style=\"color: #81A1C1\">BEGIN</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t\t</span><span style=\"color: #81A1C1\">print</span><span style=\"color: #D8DEE9FF\"> @username   </span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t</span><span style=\"color: #81A1C1\">END</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">END</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">FETCH</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">NEXT</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">FROM</span><span style=\"color: #D8DEE9FF\"> userCursor </span><span style=\"color: #81A1C1\">INTO</span><span style=\"color: #D8DEE9FF\"> @userId</span></span>\n<span class=\"line\"><span style=\"color: #81A1C1\">END</span></span>\n<span class=\"line\"><span style=\"color: #81A1C1\">CLOSE</span><span style=\"color: #D8DEE9FF\"> userCursor</span></span>\n<span class=\"line\"><span style=\"color: #81A1C1\">DEALLOCATE</span><span style=\"color: #D8DEE9FF\"> userCursor</span></span></code></pre>\n","tags":[{"title":"sitecore","path":"/tag/sitecore/"},{"title":"sql","path":"/tag/sql/"},{"title":"debugging","path":"/tag/debugging/"}],"references":[],"path":"/find-sitecore-users-with-profile-setting/"}},"context":{}}