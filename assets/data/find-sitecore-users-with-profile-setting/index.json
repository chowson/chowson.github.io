{"hash":"1abbbfc2b35e75b7958fa182c4e90f4fc6e772d0","data":{"post":{"title":"Find Sitecore users with profile setting","description":"Find Sitecore users with profile setting","date":"July 28, 2015","timeToRead":2,"content":"<p>Through the role manager, you can easily find which users are in a particular role but you can't easily\nget a list of users which are an administrator. This is because the administrator setting is stored as a\nprofile value on the user. To generate a list of administrators run the following script against your\n<em>core</em> database.</p>\n<p>You can also modify the script to find users with the existence of any profile key and optionally users which have a profile key that matches a particular  value. To do this you will need to modify the <em>@propertyKey</em> and <em>@expectedValue</em> variables at the top of the script. Leaving <em>@expectedValue</em> as an empty string will return users which have the existence of a profile key rather than trying to match it to a value.</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> @propertyKey </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> nvarchar(</span><span style=\"color: #B48EAD\">50</span><span style=\"color: #D8DEE9FF\">), @expectedValue </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> nvarchar(</span><span style=\"color: #B48EAD\">255</span><span style=\"color: #D8DEE9FF\">)</span>\n\n<span style=\"color: #4C566A\">--SET PROPERTY KEY AND EXPECTED VALUE HERE</span>\n<span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @propertyKey </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">IsAdministrator</span><span style=\"color: #ECEFF4\">'</span>\n<span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @expectedValue </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">True</span><span style=\"color: #ECEFF4\">'</span>\n\n\n<span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> @userId </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> uniqueidentifier</span>\n<span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> @username </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> nvarchar(</span><span style=\"color: #B48EAD\">255</span><span style=\"color: #D8DEE9FF\">)</span>\n\n<span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> userCursor CURSOR </span>\n<span style=\"color: #D8DEE9FF\">  LOCAL STATIC READ_ONLY FORWARD_ONLY</span>\n<span style=\"color: #D8DEE9FF\">FOR </span>\n<span style=\"color: #81A1C1\">SELECT DISTINCT</span><span style=\"color: #D8DEE9FF\"> UserId </span><span style=\"color: #81A1C1\">FROM</span><span style=\"color: #D8DEE9FF\"> aspnet_Profile </span><span style=\"color: #81A1C1\">WHERE</span><span style=\"color: #D8DEE9FF\"> PropertyNames </span><span style=\"color: #81A1C1\">LIKE</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">%</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> @propertyKey </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">%</span><span style=\"color: #ECEFF4\">'</span>\n\n<span style=\"color: #D8DEE9FF\">OPEN userCursor</span>\n<span style=\"color: #D8DEE9FF\">FETCH NEXT </span><span style=\"color: #81A1C1\">FROM</span><span style=\"color: #D8DEE9FF\"> userCursor </span><span style=\"color: #81A1C1\">INTO</span><span style=\"color: #D8DEE9FF\"> @userId</span>\n<span style=\"color: #D8DEE9FF\">WHILE @@FETCH_STATUS </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">0</span>\n<span style=\"color: #81A1C1\">BEGIN</span>\n<span style=\"color: #ECEFF4\">    </span><span style=\"color: #4C566A\">-- Get property value start/end indexes from PropertyNames</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> @propertyNames </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> NVARCHAR(max)</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @propertyNames </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #81A1C1\">SELECT</span><span style=\"color: #D8DEE9FF\"> PropertyNames </span><span style=\"color: #81A1C1\">FROM</span><span style=\"color: #D8DEE9FF\"> aspnet_Profile </span><span style=\"color: #81A1C1\">WHERE</span><span style=\"color: #D8DEE9FF\"> UserId </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> @userId)</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @username </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #81A1C1\">SELECT</span><span style=\"color: #D8DEE9FF\"> UserName </span><span style=\"color: #81A1C1\">FROM</span><span style=\"color: #D8DEE9FF\"> aspnet_Users </span><span style=\"color: #81A1C1\">WHERE</span><span style=\"color: #D8DEE9FF\"> UserId </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> @userId)</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> @startIndex </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">int</span><span style=\"color: #D8DEE9FF\">, @endIndex </span><span style=\"color: #81A1C1\">as</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">int</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @startIndex </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> (CHARINDEX(@propertyKey </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">:S:</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #D8DEE9FF\">, @propertyNames)) </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> LEN(@propertyKey </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">:S:</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #D8DEE9FF\">)</span>\n<span style=\"color: #D8DEE9FF\">    </span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> @pos </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">int</span><span style=\"color: #D8DEE9FF\">, @count </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">int</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @count </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">0</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @pos </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> @startIndex</span>\n<span style=\"color: #D8DEE9FF\">    </span>\n<span style=\"color: #D8DEE9FF\">    WHILE(@count </span><span style=\"color: #81A1C1\">!=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">2</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">AND</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #88C0D0\">SUBSTRING</span><span style=\"color: #D8DEE9FF\">(@propertyNames, @pos, </span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">) </span><span style=\"color: #81A1C1\">!=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">''</span><span style=\"color: #D8DEE9FF\">)</span>\n<span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">BEGIN</span>\n<span style=\"color: #D8DEE9FF\">\t\tIF </span><span style=\"color: #88C0D0\">SUBSTRING</span><span style=\"color: #D8DEE9FF\">(@propertyNames, @pos, </span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">) </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">:</span><span style=\"color: #ECEFF4\">'</span>\n<span style=\"color: #D8DEE9FF\">\t\t\t</span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @count </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> @count </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">1</span>\n<span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @pos </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> @pos </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">1</span>\n<span style=\"color: #D8DEE9FF\">\t\tEND</span>\n<span style=\"color: #D8DEE9FF\">    </span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @propertyNames </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #88C0D0\">SUBSTRING</span><span style=\"color: #D8DEE9FF\">(@propertyNames, @startIndex, (@pos </span><span style=\"color: #81A1C1\">-</span><span style=\"color: #D8DEE9FF\"> @startIndex </span><span style=\"color: #81A1C1\">-</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">)))</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @startIndex </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #88C0D0\">SUBSTRING</span><span style=\"color: #D8DEE9FF\">(@propertyNames, </span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">, (CHARINDEX(</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">:</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #D8DEE9FF\">, @propertyNames) </span><span style=\"color: #81A1C1\">-</span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">)))</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @endIndex </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #88C0D0\">SUBSTRING</span><span style=\"color: #D8DEE9FF\">(@propertyNames, (CHARINDEX(</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">:</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #D8DEE9FF\">, @propertyNames)  </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">), (LEN(@propertyNames) </span><span style=\"color: #81A1C1\">-</span><span style=\"color: #D8DEE9FF\"> CHARINDEX(</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">:</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #D8DEE9FF\">, @propertyNames))))</span>\n<span style=\"color: #D8DEE9FF\">    </span>\n<span style=\"color: #ECEFF4\">    </span><span style=\"color: #4C566A\">-- Verify PropertyValue for IsAdministrator profile key is 'True'</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">DECLARE</span><span style=\"color: #D8DEE9FF\"> @propertyStrings </span><span style=\"color: #81A1C1\">AS</span><span style=\"color: #D8DEE9FF\"> nvarchar(MAX)</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">SET</span><span style=\"color: #D8DEE9FF\"> @propertyStrings </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #81A1C1\">SELECT</span><span style=\"color: #D8DEE9FF\"> PropertyValuesString </span><span style=\"color: #81A1C1\">FROM</span><span style=\"color: #D8DEE9FF\"> aspnet_Profile </span><span style=\"color: #81A1C1\">WHERE</span><span style=\"color: #D8DEE9FF\"> UserId </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> @userId)</span>\n<span style=\"color: #D8DEE9FF\">\t</span>\n<span style=\"color: #D8DEE9FF\">\tIF @expectedValue </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">''</span>\n<span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">BEGIN</span>\n<span style=\"color: #D8DEE9FF\">\t\t\tprint @username </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">, </span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #88C0D0\">SUBSTRING</span><span style=\"color: #D8DEE9FF\">(@propertyStrings, @startIndex </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">, @endIndex))</span>\n<span style=\"color: #D8DEE9FF\">\t\tEND</span>\n<span style=\"color: #D8DEE9FF\">\tELSE</span>\n<span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">BEGIN</span>\n<span style=\"color: #D8DEE9FF\">\t\t\tIF </span><span style=\"color: #88C0D0\">SUBSTRING</span><span style=\"color: #D8DEE9FF\">(@propertyStrings, @startIndex, @endIndex </span><span style=\"color: #81A1C1\">+</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #B48EAD\">1</span><span style=\"color: #D8DEE9FF\">) </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> @expectedValue</span>\n<span style=\"color: #D8DEE9FF\">\t\t\t\t</span><span style=\"color: #81A1C1\">BEGIN</span>\n<span style=\"color: #D8DEE9FF\">\t\t\t\tprint @username   </span>\n<span style=\"color: #D8DEE9FF\">\t\t\tEND</span>\n<span style=\"color: #D8DEE9FF\">\t\tEND</span>\n<span style=\"color: #D8DEE9FF\">\t\t</span>\n<span style=\"color: #D8DEE9FF\">    FETCH NEXT </span><span style=\"color: #81A1C1\">FROM</span><span style=\"color: #D8DEE9FF\"> userCursor </span><span style=\"color: #81A1C1\">INTO</span><span style=\"color: #D8DEE9FF\"> @userId</span>\n<span style=\"color: #D8DEE9FF\">END</span>\n<span style=\"color: #D8DEE9FF\">CLOSE userCursor</span>\n<span style=\"color: #D8DEE9FF\">DEALLOCATE userCursor</span></code></pre>\n","tags":[{"title":"sitecore","path":"/tag/sitecore/"},{"title":"sql","path":"/tag/sql/"},{"title":"debugging","path":"/tag/debugging/"}],"references":[],"path":"/find-sitecore-users-with-profile-setting/"}},"context":{}}