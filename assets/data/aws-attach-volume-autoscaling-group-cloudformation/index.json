{"hash":"a40bfc3e54a18259212a3c45a29cc93e306df4eb","data":{"post":{"title":"Attach Volume to EC2 instance in Auto Scaling Group","description":"Attaching a volume to an EC2 instance in an Auto Scaling Group using Powershell and CloudFormation","date":"November 28, 2015","timeToRead":1,"content":"<p>During the process of creating an <em>AWS Auto Scaling group</em>, you will need to\ncreate a <em>Launch Configuration</em> to describe how EC2 instances will be created.\nWhen configuring the storage options, new volumes can be added and can be optionally\nbe based off a snapshot. However, there is no option to attach an existing volume.</p>\n<p>The reason behind this is a volume can only be attached to a single EC2 instance and\nan <em>Auto Scaling Group</em> is likely to have multiple instances created from the same\n<em>Launch Configuration</em>. However, in the scenario where a group is being scaled between 0\nand 1 instance, there is no reason why you can't add a volume to the instance when you\nscale up to 1 instance. I had this scenario with a dev server which was scaled to 0 instances\nat night and back to 1 instance during working hours.</p>\n<p>To get a volume to attach to an EC2 instance when it is created, add the following Powershell\nto the <em>UserData</em> property of the <em>Launch Configuration</em>. This ensures each time an instance\nis created, the volume will be available in the same state as the previous day.</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #81A1C1\">&lt;powershell&gt;</span>\n<span style=\"color: #D8DEE9FF\">$instanceId = Invoke-RestMethod -Uri http://169.254.169.254/latest/meta-data/instance-id </span>\n<span style=\"color: #D8DEE9FF\">Add-EC2Volume -instanceId $instanceId -VolumeId vol-xxxxxxxx -Device xvdb -Region eu-west-1</span>\n<span style=\"color: #D8DEE9FF\">Get-Disk | %{ Set-Disk -Number $_.Number -IsOffline $False }</span>\n<span style=\"color: #81A1C1\">&lt;/powershell&gt;</span></code></pre>\n<p>If you are using <em>CloudFormation</em>, this would be added to the template as follows:</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #ECEFF4\">{</span>\n<span style=\"color: #D8DEE9FF\">  </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #8FBCBB\">AWSTemplateFormatVersion</span><span style=\"color: #ECEFF4\">\":</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">2010-09-09</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #ECEFF4\">,</span>\n<span style=\"color: #D8DEE9FF\">  </span><span style=\"color: #D8DEE9\">...</span>\n<span style=\"color: #D8DEE9FF\">  </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #8FBCBB\">Resources</span><span style=\"color: #ECEFF4\">\":</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #D8DEE9\">...</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #8FBCBB\">LaunchConfig</span><span style=\"color: #ECEFF4\">\":</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span>\n<span style=\"color: #D8DEE9FF\">      </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #8FBCBB\">Type</span><span style=\"color: #ECEFF4\">\":</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">AWS::AutoScaling::LaunchConfiguration</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #ECEFF4\">,</span>\n<span style=\"color: #D8DEE9FF\">      </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #8FBCBB\">Properties</span><span style=\"color: #ECEFF4\">\":</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span>\n<span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #D8DEE9\">...</span>\n<span style=\"color: #D8DEE9FF\">    \t</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #8FBCBB\">UserData</span><span style=\"color: #ECEFF4\">\":</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span>\n<span style=\"color: #D8DEE9FF\">          </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #8FBCBB\">Fn::Base64</span><span style=\"color: #ECEFF4\">\":</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span>\n<span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #8FBCBB\">Fn::Join</span><span style=\"color: #ECEFF4\">\":</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">[</span>\n<span style=\"color: #D8DEE9FF\">              </span><span style=\"color: #ECEFF4\">\"\"</span><span style=\"color: #ECEFF4\">,</span>\n<span style=\"color: #D8DEE9FF\">              </span><span style=\"color: #ECEFF4\">[</span>\n<span style=\"color: #D8DEE9FF\">                </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">&lt;powershell&gt;</span><span style=\"color: #EBCB8B\">\\n</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #ECEFF4\">,</span>\n<span style=\"color: #D8DEE9FF\">                </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">$instanceId = Invoke-RestMethod -Uri http://169.254.169.254/latest/meta-data/instance-id </span><span style=\"color: #EBCB8B\">\\n</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #ECEFF4\">,</span>\n<span style=\"color: #D8DEE9FF\">                </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">Add-EC2Volume -instanceId $instanceId -VolumeId vol-xxxxxxxx -Device xvdb -Region eu-west-1</span><span style=\"color: #EBCB8B\">\\n</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #ECEFF4\">,</span>\n<span style=\"color: #D8DEE9FF\">                </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">Get-Disk | %{ Set-Disk -Number $_.Number -IsOffline $False }</span><span style=\"color: #EBCB8B\">\\n</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #ECEFF4\">,</span>\n<span style=\"color: #D8DEE9FF\">                </span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">&lt;/powershell&gt;</span><span style=\"color: #EBCB8B\">\\n</span><span style=\"color: #ECEFF4\">\"</span>\n<span style=\"color: #D8DEE9FF\">              </span><span style=\"color: #ECEFF4\">]</span>\n<span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #ECEFF4\">]</span>\n<span style=\"color: #D8DEE9FF\">          </span><span style=\"color: #ECEFF4\">}</span>\n<span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">}</span>\n<span style=\"color: #D8DEE9FF\">      </span><span style=\"color: #ECEFF4\">}</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #ECEFF4\">}</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #D8DEE9\">...</span>\n<span style=\"color: #D8DEE9FF\">  </span><span style=\"color: #ECEFF4\">}</span>\n<span style=\"color: #D8DEE9FF\">  </span><span style=\"color: #D8DEE9\">...</span></code></pre>\n","tags":[{"title":"aws","path":"/tag/aws/"}],"references":["http://docs.aws.amazon.com/AutoScaling/latest/DeveloperGuide/GettingStartedTutorial.html|Auto Scaling Documentation","http://docs.aws.amazon.com/AutoScaling/latest/DeveloperGuide/WorkingWithLaunchConfig.html|Creating Launch Configuration","http://docs.aws.amazon.com/AutoScaling/latest/DeveloperGuide/schedule_time.html|Scheduled Scaling"],"path":"/aws-attach-volume-autoscaling-group-cloudformation/"}},"context":{}}