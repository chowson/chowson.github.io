{"hash":"ac88158e9736ebb7f8a56d6784e5affcc0830bca","data":{"post":{"title":"Security Based Publishing Restrictions in Sitecore","description":"Providing publishing based on item security","date":"August 19, 2015","timeToRead":2,"content":"<h4 id=\"problem\"><a href=\"#problem\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Problem...</h4>\n<p>In order to grant a user permissions to publish in Sitecore, they need to be part\nof the <em>Sitecore Client Publishing</em> role. Once a user is a member of this role,\nthe publishing buttons become visible to the user within the content editor ribbon\nas well as the main menu. The consequence of this is that it grants the user permission\nto publish everything via a site publish and in larger applications this can prevent\nother users from publishing for hours with no easy way to cancel the publish job.</p>\n<p>Out of the box Sitecore provides a couple of options around this:</p>\n<ul>\n<li>\n<p>Remove read permissions to the 'Publish site' option for the role. To do this, edit the read permission on the core database item <em>/sitecore/content/Applications/Content Editor/Menues/Publish/Publish Site</em>.</p>\n<ul>\n<li>Issue: A user could still initiate a publish from the /sitecore root item and include\nall sub-items, effectively performing a site publish.</li>\n</ul>\n</li>\n<li>\n<p>Configure a publishing scheduled task to perform an periodic incremental publish picking up all new changes.</p>\n<ul>\n<li>Issue: If workflow isn't enabled on all items you can end up with things published\nthat are incomplete.</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"solution\"><a href=\"#solution\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Solution...</h4>\n<p>A potential solution around this is to hide the publishing buttons on items which the\ncontext user doesn't have permissions to write to, therefore only allowing them to publish\nsections of the tree that they can author. For areas of the tree where they only have read\naccess, the publishing button will be hidden. To achieve this, you can follow these steps:</p>\n<ol>\n<li>Create a new class that inherits the Sitecore default command and add logic to the\n<em>QueryState</em> method to check for write access, for example:</li>\n</ol>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #81A1C1\">public</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">class</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">PublishItemCheckSecurity</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">PublishItem</span>\n<span style=\"color: #ECEFF4\">{</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">public</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">override</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">CommandState</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #88C0D0\">QueryState</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #81A1C1\">CommandContext</span><span style=\"color: #D8DEE9FF\"> context</span><span style=\"color: #ECEFF4\">)</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #ECEFF4\">{</span>\n<span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #81A1C1\">var</span><span style=\"color: #D8DEE9FF\"> item </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">context</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9\">Items</span><span style=\"color: #ECEFF4\">[</span><span style=\"color: #B48EAD\">0</span><span style=\"color: #ECEFF4\">]</span><span style=\"color: #81A1C1\">;</span>\n\n<span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #81A1C1\">var</span><span style=\"color: #D8DEE9FF\"> baseState </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">base</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #88C0D0\">QueryState</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9\">context</span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #81A1C1\">;</span>\n\n<span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #81A1C1\">return</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">baseState</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">==</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">CommandState</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9\">Enabled</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">&&</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">item</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">!=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">null</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">&&</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">!</span><span style=\"color: #D8DEE9\">item</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9\">Security</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #88C0D0\">CanWrite</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9\">Context</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9\">User</span><span style=\"color: #ECEFF4\">)</span>\n<span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #81A1C1\">?</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">CommandState</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9\">Hidden</span>\n<span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">baseState</span><span style=\"color: #81A1C1\">;</span>\n<span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">}</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #ECEFF4\">}</span></code></pre>\n<ol start=\"2\">\n<li>Patch in the new command referenced in step 1 to replace the default Sitecore command:</li>\n</ol>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #81A1C1\">&lt;configuration</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">xmlns</span><span style=\"color: #ECEFF4\">:</span><span style=\"color: #8FBCBB\">patch</span><span style=\"color: #D8DEE9FF\">=</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">http://www.sitecore.net/xmlconfig/</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #81A1C1\">&gt;</span>\n<span style=\"color: #D8DEE9FF\">  </span><span style=\"color: #81A1C1\">&lt;sitecore&gt;</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">&lt;commands&gt;</span>\n<span style=\"color: #D8DEE9FF\">      </span><span style=\"color: #81A1C1\">&lt;command</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">name</span><span style=\"color: #D8DEE9FF\">=</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">item:publishnow</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #81A1C1\">&gt;</span>\n<span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #81A1C1\">&lt;</span><span style=\"color: #8FBCBB\">patch</span><span style=\"color: #ECEFF4\">:</span><span style=\"color: #81A1C1\">attribute</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">name</span><span style=\"color: #D8DEE9FF\">=</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">type</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #81A1C1\">&gt;</span><span style=\"color: #D8DEE9FF\">Your.Namespace.PublishItemCheckSecurity, Your.Namespace</span><span style=\"color: #81A1C1\">&lt;/</span><span style=\"color: #8FBCBB\">patch</span><span style=\"color: #ECEFF4\">:</span><span style=\"color: #81A1C1\">attribute&gt;</span>\n<span style=\"color: #D8DEE9FF\">      </span><span style=\"color: #81A1C1\">&lt;/command&gt;</span>\n<span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">&lt;/commands&gt;</span>\n<span style=\"color: #D8DEE9FF\">  </span><span style=\"color: #81A1C1\">&lt;/sitecore&gt;</span>\n<span style=\"color: #81A1C1\">&lt;/configuration&gt;</span></code></pre>\n<p>Once your solution recompiled, create a new user which is a member of the <em>Sitecore Client Publishing</em>\nrole and then viewing different content items should see the button appearing for items\nthe user can write to and disappearing for items that they cannot.</p>\n","tags":[{"title":"sitecore","path":"/tag/sitecore/"}],"references":[],"path":"/security-based-publishing-restrictions-in-sitecore/"}},"context":{}}